<project default="jars">
	<property name="version" value="SNAPSHOT"/> <!-- Override this property to build release versions -->

	<property name="build.dir" location="build"/>
	<property name="lib.dir" location="lib"/>
	<property name="dist.dir" location="${build.dir}/dist"/>

    <property name="report.test.unit.dir" location="${build.dir}/reports/unit-tests"/>
    <property name="report.test.acceptance.dir" location="${build.dir}/reports/acceptance-tests"/>

    <property name="examples.dir" location="examples"/>
    <property name="extensions.dir" location="extensions"/>

    <property name="core.dir" location="core"/>
    <property name="core.src.dir" location="${core.dir}/src"/>
    <property name="core.atest.dir" location="${core.dir}/acceptance-tests"/>
	<property name="core.build.dir" location="build/core"/>
	<property name="core.jar" location="${dist.dir}/jmock-${version}.jar"/>
	
    <property name="cglib.dir" location="${extensions.dir}/cglib"/>
    <property name="cglib.src.dir" location="${cglib.dir}/src"/>
    <property name="cglib.atest.dir" location="${cglib.dir}/acceptance-tests"/>
	<property name="cglib.build.dir" location="build/cglib"/>
	<property name="cglib.jar" location="${dist.dir}/jmock-cglib-${version}.jar"/>

    <property name="src.jar" location="${dist.dir}/jmock-${version}-src.jar"/>


    <!-- JMOCK CORE -->

    <target name="core.build.dir">
        <mkdir dir="${core.build.dir}"/>
    </target>

	<target name="core.compile" depends="core.build.dir" >
		<javac srcdir="${core.src.dir}" destdir="${core.build.dir}">
			<classpath>
				<fileset dir="${lib.dir}"/>
			</classpath>
		</javac>
	</target>

    <target name="core.atest.compile" depends="core.compile">
        <javac srcdir="${core.atest.dir}" destdir="${core.build.dir}">
            <classpath>
                <fileset dir="${lib.dir}"/>
            </classpath>
        </javac>
    </target>

    <!-- CGLIB EXTENSION -->

    <target name="cglib.build.dir">
        <mkdir dir="${cglib.build.dir}"/>
    </target>

	<target name="cglib.compile" depends="cglib.build.dir" >
		<javac srcdir="${cglib.src.dir}" destdir="${cglib.build.dir}">
			<classpath>
				<fileset dir="${lib.dir}"/>
				<pathelement path="${core.build.dir}"/>
			</classpath>
		</javac>
	</target>

    <target name="cglib.atest.compile" depends="cglib.compile" >
        <javac srcdir="${cglib.atest.dir}" destdir="${cglib.build.dir}">
            <classpath>
                <fileset dir="${lib.dir}"/>
                <pathelement path="${core.build.dir}"/>
            </classpath>
        </javac>
    </target>

    <!-- JAR FILES -->

    <target name="jars" depends="core.jar,cglib.jar,src.jar"/>

	<target name="core.jar" depends="core.compile">
		<mkdir dir="${dist.dir}"/>
		<jar basedir="${core.build.dir}" destfile="${core.jar}" excludes="test/**" index="true"/>
	</target>
	
	<target name="cglib.jar" depends="cglib.compile">
		<mkdir dir="${dist.dir}"/>
		<jar basedir="${cglib.build.dir}" destfile="${cglib.jar}" excludes="test/**" index="true"/>
	</target>

    <target name="src.jar">
        <mkdir dir="${dist.dir}"/>
        <jar destfile="${src.jar}">
            <fileset dir="${core.dir}"/>
            <fileset dir="${extensions.dir}"/>
            <fileset dir="${examples.dir}"/>
            <filename name="build.xml"/>
            <filename name="README.txt"/>
            <filename name="LICENSE.txt"/>
            <filename name="overview.html"/>
        </jar>
    </target>

    <!-- TESTS -->
    <!-- NOTE: not working yet -->

    <target name="test" depends="test.unit,test.acceptance"/>

    <target name="test.unit" depends="core.compile,cglib.compile">
        <!-- Must add lib/junit.jar to the CLASSPATH to run this task -->
        <mkdir dir="${report.test.unit.dir}"/>
        <junit printsummary="yes" haltonerror="true">
            <formatter type="plain"/>
            <batchtest fork="no" todir="${report.test.unit.dir}">
                <fileset dir="${core.src.dir}" includes="test/**/*Test.java"/>
                <fileset dir="${cglib.src.dir}" includes="test/**/*Test.java"/>
            </batchtest>
        </junit>
    </target>

    <target name="test.acceptance" depends="core.atest.compile,cglib.atest.compile">
        <!-- Must add lib/junit.jar to the CLASSPATH to run this task -->
        <mkdir dir="${report.test.acceptance.dir}"/>
        <junit printsummary="yes" haltonerror="true">
            <formatter type="plain"/>
            <batchtest fork="no" todir="${report.test.acceptance.dir}">
                <fileset dir="${core.atest.dir}" includes="atest/**/*Test.java"/>
                <fileset dir="${cglib.atest.dir}" includes="atest/**/*Test.java"/>
            </batchtest>
        </junit>
    </target>

	<target name="clean">
		<delete dir="${build.dir}"/>
	</target>
	
	<target name="rebuild" depends="clean,jars"/>
</project>
