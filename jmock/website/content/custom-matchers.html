<html>
  <head>
    <title>Writing Custom Invocation Matchers</title>
  </head>
  
  <body>
    <h1>DRAFT</h1>
    
    <h1>Writing Custom Invocation Matchers</h1>
    
    <p>Invocation matchers control how a mock object matches and verifies incoming invocations 
    against expectations and stubbed behaviour.
    The jMock API is a convenient syntactic sugar for specifying how matchers are added to
    a mock object.
    Sometimes the convenient API does not allow you to specify matching rules precisely or
    flexibly enough.
    In these cases you will need to write your own invocation matcher classes.
    This article will show you how to do just that.
    </p>
    
    <p><em>TODO: how invocation matchers are matched against incoming invocations.</em></p>
    
	<p>An invocation matcher is an object that implements the 
    <code><a href="docs/javadoc/org/jmock/core/InvocationMatcher">InvocationMatcher</a></code>
    interface. It has the following responsiblities:</p>
    
    <ul>
      <li>report whether it matches against an invocation
      (the <code>match</code> method).</li>
      <li>check and record information about a dispatched invocation, if required
      (the <code>invoked</code> method).</li>
      <li>verify that expected invocations have actually been received.
      (the <code>verify</code> method from the 
      <a href="docs/javadoc/org/jmock/core/Verifiable.html"><code>Verifiable</code></a>
      interface).</li>
      <li>provide a readable description to be included in test failure messages 
      (the <code>describeTo</code> method from the 
      <a href="docs/javadoc/org/jmock/core/SelfDescribing.html"><code>SelfDescribing</code></a>
      interface).</li>
      <li>report if its description is not an empty string
      (the <code>hasDescription</code> method).</li>
    </ul>
    
    <p>In most cases, you will want to define a new matching rule that does not care if a matched
    invocation actually occurs.  Also, you should always provide
    a description for your matching rule, so the <code>hasDescription</code> method should
    always return <code>true</code>.  This common behaviour is already implemented in the
    abstract
    <a href="docs/javadoc/org/jmock/core/matcher/StatelessInvocationMatcher.html"><code>StatelessInvocationMatcher</code></a>
    class.  You can therefore define a new matching rule by extending 
    <code>StatelessInvocationMatcher</code> and defining the 
    <code>match</code> and <code>describeTo</code> methods.</p>
    
    <h2>An Example Custom Matcher</h2>
    
    <p>Suppose we want to stub all Java Bean property getters to return some default results.
    Returning default results is performed by a
    <a href="docs/javadoc/org/jmock/core/stub/DefaultResultStub.html"><code>DefaultResultStub</code></a>.
    But how do we match property getter methods?  We need to write a custom 
    InvocationMatcher that only matches invocations of bean property getter methods.
    Here's what a test will look like that uses such a custom matcher:</p>
    
    <div class="Source Java">
<pre>InvocationMatcher beanPropertyGetters = new BeanPropertyGetterMatcher();
DefaultResultStub returnDefaultValue = new DefaultResultStub();
Mock mock = ...
    
public void testListChildren() {
    ...        
    mockPerson.stub().match(beanPropertyGetters).will(returnDefaultValue);
    ...
}</pre>
    </div>
    
    <p>We can write the BeanPropertyGetterMatcher class by extending StatelessInvocationMatcher:</p>
    
    <div class="Source Java">
<pre>public class BeanPropertyGetterMatcher 
    extends StatelessInvocationMatcher 
{
   ...
}</pre>    
    </div>
    
    <p>We now need to write the <code>match</code> method to return whether the invocation is
    the getter method of a Java Bean property, using the Java Beans API.  The method will
    use Bean introspection to list the property descriptors of the class that defines the
    invoked method.  It then searches the list of property descriptors for a descriptor with
    a getter method that is the same as the invoked method.</p>
    
  </body>
</html>
