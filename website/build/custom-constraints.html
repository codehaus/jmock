<?xml version="1.0" encoding="utf8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:html="http://www.w3.org/1999/xhtml">
  <head>
    <title>jMock - Writing Custom Constraints</title>
    <link media="screen" rel="stylesheet" title="Navigation View" type="text/css" href="jmock.css"/>
    <link media="screen" rel="alternate stylesheet" type="text/css" href="print.css" title="Print Preview"/>
    <link media="print" rel="stylesheet" type="text/css" href="print.css"/>
  </head>
  <body>
    <div id="banner">
      <a href="/home/nat/projects/jmock-website/build/local/index.html">
        <img id="logo" src="logo.png" alt="jMock"/>
      </a>
    </div>
    <div id="center" class="Content2Column">
      <div id="content">
        <h1>Writing Custom Constraints</h1>
        <p>jMock provides several classes and factory functions that define 
<a href="constraints.html">constraints over the acceptable parameter values of a method invocation</a><sup class="LinkFootnoteRef">1</sup>.
Sometimes, however, the predefined constraints do not let you specify an
expectation accurately enough to keep your tests flexible. In such cases, you
can easily define new constraints that seamlessly extend the existing
constraints defined by jMock.</p>
        <p>A constraint is an object that implements the <code><a href="java:org.jmock.core.Constraint">Constraint</a><sup class="LinkFootnoteRef">2</sup></code>
interface. It does two things:</p>
        <ul>
  <li>report whether a parameter value meets the constraint (the
    <code>eval</code> method).</li>
  <li>provide a readable description to be included in test failure messages
    (the <code>describeTo</code> method from the <a href="java:org.jmock.core.SelfDescribing"><code>SelfDescribing</code></a><sup class="LinkFootnoteRef">3</sup>
    interface).</li>
</ul>
        <p>The <code><a href="java:org.jmock.core.constraint.*">org.jmock.constraint</a><sup class="LinkFootnoteRef">4</sup></code>
package contains many constraint implementations and the programmer can
easily specify their own constraints by writing their own implementations of
the <code>Constraint</code> interface.</p>
        <p>To create a new constraint:</p>
        <ol>
  <li><p>Write a class that implements the <code>Constraint</code> interface.
    The following constraint class tests whether a string starts with a given
    prefix.</p>

    <div class="Source Java">
    <pre>import org.jmock.core.Constraint;

public class StringStartsWith implements Constraint {
    private String prefix;

    public StringStartsWith( String prefix ) {
        this.prefix = prefix;
    }

    public boolean eval( Object o ) {
        return o instanceof String &amp;&amp; ((String)o).startsWith(prefix);
    }

    public StringBuffer describeTo( StringBuffer buffer ) {
        return buffer.append("a string starting with ")
                     .append(Formatting.toReadableString(prefix));
    }
}</pre>
    </div>
    
    <p>Note that the <code>describeTo</code> method calls <code>Formatting.toReadableString</code> to format 
    the prefix.  The <code>toReadableString</code> method formats any raw value in a way that subtly indicates
    the value's type and should be used to format any raw values stored in your constraints so that error
    messages are easy to read.</p>
  </li>
  <li><p>Write a factory method in your test case that creates an instance of
    your new constraint.</p>

    <div class="Source Java">
    <pre>public class MyTestCase extends MockObjectTestCase {
    ...

    private Constraint aStringStartingWith( String prefix ) {
        return new StringStartsWith(prefix);
    }
}</pre>
    </div>
  </li>
  <li><p>Use your factory method to create constraints in your tests. The
    following expectation specifies that the error method of the mockLogger
    object must be called once with an argument that is a string starting
    with "FATAL".</p>

    <div class="Source Java">
    <pre>public class MyTestCase extends MockObjectTestCase {
    ...

    public void testSomething() {
        ...

        mockLogger.expects(once()).method("error").with( aStringStartingWith("FATAL") );

        ...
    }

    private Constraint aStringStartingWith( String prefix ) {
        return new StringStartsWith(prefix);
    }
}</pre>
    </div>
  </li>
</ol>
        <h2>An Important Rule</h2>
        <p>
          <strong>Constraint objects must be stateless.</strong>
        </p>
        <p>When <a href="dispatch.html">dispatching</a><sup class="LinkFootnoteRef">5</sup> each invocation, 
jMock uses the constraints to find an expectation that matches the invocation's arguments.
This means that it will call the constraints many times during the test, maybe even after
the expectation has been matched and invoked.  In fact, jMock gives no guarantees of when
and how many times it will call the constraints.  This has no effect on stateless constraint
objects but means that the function of stateful constraint objects cannot be predicted.</p>
        <p>If you want to maintain state in response to invocations, use a custom 
<a href="custom-stubs.html">Stub</a><sup class="LinkFootnoteRef">6</sup> or <a href="custom-matchers.html">Matcher</a><sup class="LinkFootnoteRef">7</sup>.</p>
      </div>
      <div class="LinkFootnotes">
        <p class="LinkFootnotesHeader">Links:</p>
        <p>1. constraints over the acceptable parameter values of a method invocation: constraints.html</p>
        <p>2. Constraint: java:org.jmock.core.Constraint</p>
        <p>3. SelfDescribing: java:org.jmock.core.SelfDescribing</p>
        <p>4. org.jmock.constraint: java:org.jmock.core.constraint.*</p>
        <p>5. dispatching: dispatch.html</p>
        <p>6. Stub: custom-stubs.html</p>
        <p>7. Matcher: custom-matchers.html</p>
      </div>
      <div class="Meta">
        <p>
          <a href="http://cvs.jmock.codehaus.org/jmock/website/content/custom-constraints.html">Document History</a>
        </p>
      </div>
    </div>
    <div class="SidePanel" id="left">
      <div class="MenuGroup">
        <h1>
          <a href="download.html">Software</a>
        </h1>
        <ul>
          <li>
            <a href="download.html">Download</a>
          </li>
          <li>
            <a href="repository.html">Anonymous CVS Access</a>
          </li>
          <li>
            <a href="license.html">Project License</a>
          </li>
        </ul>
      </div>
      <div class="MenuGroup">
        <h1>
          <a href="docs.html">Documentation</a>
        </h1>
        <ul>
          <li>
            <a href="getting-started.html">Getting Started</a>
          </li>
          <li>
            <a href="docs/javadoc/index.html" target="jmock-javadoc">JavaDocs</a>
          </li>
          <li class="More">
            <a href="docs.html">More...</a>
          </li>
        </ul>
      </div>
      <div class="MenuGroup">
        <h1>User Support</h1>
        <ul>
          <li>
            <a href="mailing-lists.html">Mailing Lists</a>
          </li>
          <li>
            <a href="http://jira.codehaus.org/secure/BrowseProject.jspa?id=10336">Issue Tracker</a>
          </li>
          <li>
            <a href="news-rss2.xml">News Feed (RSS 2.0)</a>
          </li>
        </ul>
      </div>
      <div class="MenuGroup">
        <h1>
          <a href="development.html">Development</a>
        </h1>
        <ul>
          <li>
            <a href="how-to-contribute.html">How to Contribute</a>
          </li>
          <li>
            <a href="team.html">Development Team</a>
          </li>
          <li class="More">
            <a href="development.html">More...</a>
          </li>
        </ul>
      </div>
      <div class="MenuGroup">
        <h1>Extensions</h1>
        <ul>
          <li>
            <a href="http://jdummy.sf.net">jDummy</a>
          </li>
        </ul>
      </div>
      <div class="MenuGroup">
        <h1>Related Sites</h1>
        <ul>
          <li>
            <a href="http://www.mockobjects.com">All about Mock Objects</a>
          </li>
          <li>
            <a href="http://www.junit.org">JUnit</a>
          </li>
          <li>
            <a href="http://www.codehaus.org">Project hosted by Codehaus</a>
          </li>
        </ul>
      </div>
    </div>
  </body>
</html>
