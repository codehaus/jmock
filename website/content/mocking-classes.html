<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN"
      "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <title>Mocking Classes with CGLIB</title>
</head>

<body>
<h1>Mocking Classes with jMock and CGLIB</h1>

<p>Because it uses Java's standard reflection capability, the default
configuration of the jMock framework can only mock interfaces, not classes.
(Actually, we consider that to be a good thing because it encourages the
design to focus on communication between objects rather than classification
or data storage). However, the optional class <code><a
href="http://cvs.jmock.codehaus.org/browse/~raw,r=HEAD/jmock/jmock2/src/org/jmock/lib/nonstd/UnsafeHackConcreteClassImposteriser.java">org.jmock.lib.nonstd.UnsafeHackConcreteClassImposteriser</a></code>
uses the <a href="http://cglib.sourceforge.net">CGLIB 2</a> library to create
mock objects of classes as well as interfaces.</p>

<p class="Note Warning">The <code>UnsafeHackConcreteClassImposteriser</code>
uses a non-standard hack to completely bypass the constructor of the class
when creating mock objects. This only works on some versions of Sun's JVM.
We can't support this class so we don't distribute it as part of
the released jMock packages. If you want to use it you must either copy the
class into your own project and build it yourself or <a
href="repository.html">check the jMock source out of CVS</a> and build the
JAR with the Ant build-file<code></code>.</p>

<p>Assuming you are building the <code>UnsafeHackConcreteClassImposteriser</code> class
from jMock source.</p>
<ol>
  <li>Download <a
    href="http://sourceforge.net/project/showfiles.php?group_id=56933&amp;package_id=98218">CGLIB
    2</a>.</li>
  <li>In the root of the jMock source tree, build the jmock-nonstd-2.0.0.jar
    file with the command '<code>ant jar.unsafe</code>'. This will create a
    JAR file called
    <code>jmock-nonstd-</code><var>version</var><code>.jar</code> in the
    build subdirectory of the jMock source tree.</li>
  <li>Add CGLIB and the
    <code>jmock-nonstd-</code><var>version</var><code>.jar</code> file to the
    CLASSPATH.</li>
  <li>In your tests, plug the
    <code>UnsafeHackConcreteClassImposteriser</code> into the Mockery: 
    <pre class="Source Java">import org.jmock.Mockery;
import org.jmock.Expectations;
import org.jmock.lib.nonstd.UnsafeHackConcreteClassImposteriser;

public class ConcreteClassTest extends TestCase {
    private Mockery context = new Mockery() {{
        setImposteriser(UnsafeHackConcreteClassImposteriser.INSTANCE);
    }};
    
    ...
}</pre>
  </li>
  <li>Your tests can now create mocks of abstract or even concrete classes: 
    <pre class="Source Java">Graphics g = context.mock(java.awt.Graphics.class);</pre>
  </li>
</ol>
</body>
</html>
